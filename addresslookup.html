<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Lookup - AUSOTS</title>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#000000',
                        secondary: '#6B7280',
                        accent: '#000000',
                        danger: '#000000'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'hand': ['Kalam', 'cursive', 'system-ui']
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for autocomplete dropdown positioning */

        /* Autocomplete dropdown positioning */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
        }
    </style>
</head>
<body class="h-full bg-gray-50 font-sans">
    <div class="min-h-full py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white border-2 border-black rounded-lg shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-hand font-bold text-black mb-6 sm:mb-8 text-center">
                    Address Lookup
                </h1>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 sm:mb-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-black mb-2 font-hand">
                            Username:
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            placeholder="Enter username"
                            class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans"
                        >
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-black mb-2 font-hand">
                            Password:
                        </label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="Enter password"
                            class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans"
                        >
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 sm:mb-6">
                    <div>
                        <label for="locale" class="block text-sm font-medium text-black mb-2 font-hand">
                            Choose Locale:
                        </label>
                        <select 
                            id="locale" 
                            name="locale"
                            class="w-full px-3 py-2 border-2 border-black rounded-md focus:ring-2 focus:ring-black focus:border-transparent font-sans"
                        >
                            <option value="AU">AU</option>
                            <option value="NZ">NZ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="sot" class="block text-sm font-medium text-black mb-2 font-hand">
                            Choose Source of Truth:
                        </label>
                        <select 
                            id="sot" 
                            name="sot"
                            class="w-full px-3 py-2 border-2 border-black rounded-md focus:ring-2 focus:ring-black focus:border-transparent font-sans"
                        >
                            <option value="AUPAF">AUPAF</option>
                            <option value="GNAF">GNAF</option>
                            <option value="AUSOTS" selected>AUSOTS</option>
                        </select>
                    </div>
                </div>

                <div class="relative mb-4 sm:mb-6">
                    <label for="address" class="block text-sm font-medium text-black mb-2 font-hand">
                        Enter Address:
                    </label>
                    <input 
                        type="text" 
                        id="address" 
                        name="address" 
                        placeholder="Start typing an address..."
                        autocomplete="off"
                        class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base sm:text-lg font-sans"
                    >
                    <div class="autocomplete-dropdown hidden" id="autocompleteDropdown"></div>
                </div>

                <div id="error" class="hidden bg-red-50 border-2 border-black text-black p-3 rounded-lg mb-4 font-sans"></div>

                <div id="addressDetails" class="hidden bg-white border-2 border-black rounded-lg shadow-md p-4 sm:p-6 mt-6 sm:mt-8"></div>
                <div id="retrieveDetails" class="hidden bg-white border-2 border-black rounded-lg shadow-md p-4 sm:p-6 mt-6 sm:mt-8"></div>
            </div>
        </div>
    </div>

    <script>
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const localeSelect = document.getElementById('locale');
        const sotSelect = document.getElementById('sot');
        const addressInput = document.getElementById('address');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        const error = document.getElementById('error');
        const addressDetails = document.getElementById('addressDetails');
        const retrieveDetails = document.getElementById('retrieveDetails');

        const API_ENDPOINT = 'https://hosted.mastersoftgroup.com/harmony/rest/v2/address/find';
        const RETRIEVE_ENDPOINT = 'https://hosted.mastersoftgroup.com/harmony/rest/v2/address/retrieve';

        // SOT options by locale
        const SOT_OPTIONS = {
            'AU': ['AUPAF', 'GNAF', 'AUSOTS'],
            'NZ': ['NZPAF', 'NZAD', 'CNAR']
        };

        let debounceTimer = null;
        let currentResults = [];
        let selectedIndex = -1;
        let currentRequest = null;

        // Initialize SOT options based on default locale
        function updateSOTOptions() {
            const locale = localeSelect.value;
            const currentSOT = sotSelect.value;
            const availableSOTs = SOT_OPTIONS[locale] || [];
            
            // Clear and repopulate SOT options
            sotSelect.innerHTML = '';
            availableSOTs.forEach(sot => {
                const option = document.createElement('option');
                option.value = sot;
                option.textContent = sot;
                if (sot === currentSOT && availableSOTs.includes(currentSOT)) {
                    option.selected = true;
                }
                sotSelect.appendChild(option);
            });
            
            // If current SOT is not available for new locale, select first available
            if (!availableSOTs.includes(currentSOT)) {
                sotSelect.value = availableSOTs[0];
            }
        }

        // Update SOT options when locale changes
        localeSelect.addEventListener('change', () => {
            updateSOTOptions();
            updatePlaceholder();
            hideAutocomplete();
            hideAddressDetails();
        });

        // Update placeholder based on locale
        function updatePlaceholder() {
            const locale = localeSelect.value;
            if (locale === 'AU') {
                addressInput.placeholder = 'Start typing an address... (e.g., 20 Bond St Sydney)';
            } else {
                addressInput.placeholder = 'Start typing an address... (e.g., 123 Queen St Auckland)';
            }
        }

        // Initialize on page load
        updateSOTOptions();
        updatePlaceholder();

        // Debounced input handler
        addressInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            // Clear previous timer
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }

            // Hide details when typing
            hideAddressDetails();

            if (query.length < 3) {
                hideAutocomplete();
                return;
            }

            // Debounce the search
            debounceTimer = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        // Keyboard navigation
        addressInput.addEventListener('keydown', (e) => {
            if (autocompleteDropdown.classList.contains('hidden') || currentResults.length === 0) {
                return;
            }

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
                    updateHighlight();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateHighlight();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectedIndex < currentResults.length) {
                        const selectedAddress = currentResults[selectedIndex];
                        selectAddressFromResults(selectedAddress);
                    }
                    break;
                case 'Escape':
                    hideAutocomplete();
                    addressInput.blur();
                    break;
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!addressInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                hideAutocomplete();
            }
        });

        async function searchAddress(fullAddress) {
            // Cancel previous request if still pending
            if (currentRequest) {
                // Note: fetch doesn't support cancellation directly, but we can ignore the response
            }

            hideError();
            selectedIndex = -1;

            const locale = localeSelect.value;
            const sot = sotSelect.value;
            const countryCode = locale; // AU or NZ

            try {
                const requestBody = {
                    payload: [
                        {
                            country: countryCode,
                            fullAddress: fullAddress
                        }
                    ],
                    sourceOfTruth: sot,
                    featureOptions: {
                        exposeAttributes: "7",
                        singleLineHitNumber: "20",
                        baseSource: sot,
                        standardizeSource: sot,
                        suppressLot: "1"
                    }
                };

                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!username || !password) {
                    showError('Please enter username and password');
                    hideAutocomplete();
                    return;
                }
                
                const credentials = btoa(`${username}:${password}`);
                
                showAutocompleteLoading();
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${credentials}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (data.status === 'SUCCESS') {
                    currentResults = data.payload || [];
                    displayAutocompleteResults(currentResults);
                } else {
                    const errorMsg = data.messages && data.messages.length > 0 
                        ? data.messages.join(', ') 
                        : 'Unknown error occurred';
                    showError(`API Error: ${errorMsg}`);
                    hideAutocomplete();
                }
            } catch (err) {
                console.error('Error in searchAddress:', err);
                let errorMessage = err.message;
                
                // Check for CORS errors
                if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError') || err.message.includes('CORS')) {
                    errorMessage = 'CORS Error: The request was blocked. This might be due to CORS policy. Check browser console for details.';
                }
                
                showError(`Error: ${errorMessage}`);
                hideAutocomplete();
            }
        }

        function displayAutocompleteResults(addresses) {
            if (addresses.length === 0) {
                autocompleteDropdown.innerHTML = '<div class="p-4 text-center text-gray-600 font-sans">No addresses found</div>';
            } else {
                autocompleteDropdown.innerHTML = `
                    <div class="bg-white border-2 border-black border-t-0 rounded-b-lg max-h-96 overflow-y-auto shadow-lg">
                        ${addresses.map((addr, index) => {
                            const addrJson = JSON.stringify(addr).replace(/"/g, '&quot;');
                            return `
                                <div class="autocomplete-item p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-index="${index}" data-address='${addrJson}'>
                                    <div class="text-black font-medium font-sans">${escapeHtml(addr.fullAddress)}</div>
                                    <div class="text-gray-600 text-xs font-mono mt-1">ID: ${escapeHtml(addr.id || 'N/A')}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                // Add click handlers
                autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        const address = JSON.parse(item.getAttribute('data-address').replace(/&quot;/g, '"'));
                        selectAddressFromResults(address);
                    });
                });
            }
            showAutocomplete();
        }

        function showAutocompleteLoading() {
            autocompleteDropdown.innerHTML = '<div class="bg-white border-2 border-black border-t-0 rounded-b-lg p-4 text-center text-black font-sans">Searching...</div>';
            showAutocomplete();
        }

        function updateHighlight() {
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('bg-gray-100');
                    item.classList.remove('bg-gray-50');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('bg-gray-100');
                }
            });
        }

        async function selectAddressFromResults(address) {
            addressInput.value = address.fullAddress;
            hideAutocomplete();
            showAddressDetails(address);
            addressInput.focus();
            
            // Call retrieve API if address has an ID
            if (address.id) {
                await retrieveAddress(address.id);
            }
        }

        // Make selectAddressFromResults globally accessible for keyboard navigation
        window.selectAddressFromResults = selectAddressFromResults;

        function showAddressDetails(address) {
            const detailsHtml = `
                <div class="text-xl font-hand font-bold text-black mb-4 sm:mb-6 pb-3 border-b-2 border-black">
                    Address Details
                </div>
                
                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Address Information</div>
                    <div class="flex flex-col sm:flex-row mb-3">
                        <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand">Full Address:</div>
                        <div class="text-black flex-1 font-sans">${escapeHtml(address.fullAddress || 'N/A')}</div>
                    </div>
                    <div class="flex flex-col sm:flex-row mb-3">
                        <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand">Address ID:</div>
                        <div class="text-black flex-1 font-sans">${escapeHtml(address.id || 'N/A')}</div>
                    </div>
                    <div class="flex flex-col sm:flex-row mb-3">
                        <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand">Type:</div>
                        <div class="text-black flex-1 font-sans">${escapeHtml(address._type || 'N/A')}</div>
                    </div>
                </div>

                ${address.attributes ? `
                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Attributes</div>
                    ${Object.entries(address.attributes).map(([key, value]) => `
                        <div class="flex flex-col sm:flex-row mb-3">
                            <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand">${escapeHtml(key)}:</div>
                            <div class="text-black flex-1 font-sans break-words">${escapeHtml(String(value))}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Raw Data</div>
                    <div class="bg-white p-3 rounded border border-gray-300 overflow-x-auto">
                        <pre class="text-xs font-mono text-black">${escapeHtml(JSON.stringify(address, null, 2))}</pre>
                    </div>
                </div>
            `;
            
            addressDetails.innerHTML = detailsHtml;
            addressDetails.classList.remove('hidden');
        }

        function showAutocomplete() {
            autocompleteDropdown.classList.remove('hidden');
        }

        function hideAutocomplete() {
            autocompleteDropdown.classList.add('hidden');
            selectedIndex = -1;
        }

        function showError(message) {
            error.textContent = message;
            error.classList.remove('hidden');
        }

        function hideError() {
            error.classList.add('hidden');
        }

        function hideAddressDetails() {
            addressDetails.classList.add('hidden');
            retrieveDetails.classList.add('hidden');
        }

        async function retrieveAddress(addressId) {
            hideError();
            retrieveDetails.innerHTML = '<div class="text-center py-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div><p class="mt-2 text-black font-hand">Retrieving detailed address information...</p></div>';
            retrieveDetails.classList.remove('hidden');

            try {
                const requestBody = {
                    payload: [
                        {
                            id: addressId
                        }
                    ],
                    featureOptions: {
                        exposeAttributes: "7",
                        suppressLot: "1"
                    }
                };

                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!username || !password) {
                    showError('Please enter username and password');
                    retrieveDetails.classList.add('hidden');
                    return;
                }
                
                const credentials = btoa(`${username}:${password}`);
                
                const response = await fetch(RETRIEVE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${credentials}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (data.status === 'SUCCESS' && data.payload && data.payload.length > 0) {
                    showRetrieveDetails(data.payload[0]);
                } else {
                    const errorMsg = data.messages && data.messages.length > 0 
                        ? data.messages.join(', ') 
                        : 'No address details retrieved';
                    showError(`Retrieve Error: ${errorMsg}`);
                    retrieveDetails.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error in retrieveAddress:', err);
                showError(`Retrieve Error: ${err.message}`);
                retrieveDetails.classList.remove('active');
            }
        }

        function showRetrieveDetails(address) {
            const detailsHtml = `
                <div class="text-xl font-hand font-bold text-black mb-4 sm:mb-6 pb-3 border-b-2 border-black">
                    Retrieved Address Details
                </div>
                
                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Basic Information</div>
                    ${['fullAddress', 'country', 'state', 'locality', 'postcode', 'sourceOfTruth'].map(field => `
                        <div class="flex flex-col sm:flex-row mb-3">
                            <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}:</div>
                            <div class="text-black flex-1 font-sans">${escapeHtml(address[field] || 'N/A')}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Street Information</div>
                    ${['streetNumber', 'streetName', 'streetType', 'street', 'streetSuffix', 'street2'].map(field => `
                        <div class="flex flex-col sm:flex-row mb-3">
                            <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}:</div>
                            <div class="text-black flex-1 font-sans">${escapeHtml(address[field] || 'N/A')}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Property Details</div>
                    ${['buildingName', 'flatUnitNumber', 'flatUnitType', 'floorLevelNumber', 'floorLevelType', 'subdwelling', 'lotNumber'].map(field => `
                        <div class="flex flex-col sm:flex-row mb-3">
                            <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}:</div>
                            <div class="text-black flex-1 font-sans">${escapeHtml(address[field] || 'N/A')}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Postal Information</div>
                    ${['postal', 'postalType', 'postalNumber'].map(field => `
                        <div class="flex flex-col sm:flex-row mb-3">
                            <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}:</div>
                            <div class="text-black flex-1 font-sans">${escapeHtml(address[field] || 'N/A')}</div>
                        </div>
                    `).join('')}
                </div>

                ${address.attributes ? `
                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Geographic & Statistical Attributes</div>
                    ${Object.entries(address.attributes)
                        .filter(([key]) => !key.startsWith('_'))
                        .map(([key, value]) => `
                            <div class="flex flex-col sm:flex-row mb-3">
                                <div class="font-semibold text-black min-w-[140px] mb-1 sm:mb-0 sm:mr-3 font-hand">${escapeHtml(key)}:</div>
                                <div class="text-black flex-1 font-sans break-words">${escapeHtml(String(value))}</div>
                            </div>
                        `).join('')}
                </div>
                ` : ''}

                ${address.exception ? `
                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Exception</div>
                    <div class="text-black font-sans">${escapeHtml(String(address.exception))}</div>
                </div>
                ` : ''}

                <div class="mb-4 sm:mb-6">
                    <div class="text-base font-hand font-bold text-black mb-3">Raw Retrieve Data</div>
                    <div class="bg-white p-3 rounded border border-gray-300 overflow-x-auto">
                        <pre class="text-xs font-mono text-black">${escapeHtml(JSON.stringify(address, null, 2))}</pre>
                    </div>
                </div>
            `;
            
            retrieveDetails.innerHTML = detailsHtml;
            retrieveDetails.classList.remove('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

